var convertSessionToOrder=function(){var r={vars:{focusFieldset:'',containerID:'',echeck:{"payment.ea":"Account #","payment.er":"Routing #","payment.en":"Account Name","payment.eb":"Bank Name","payment.es":"Bank State","payment.ei":"Check #"},legends:{"chkoutPreflight":"Contact Information","chkoutAccountInfo":"Account Information","chkoutBillAddress":"Billing Address","chkoutShipAddress":"Shipping Address","chkoutShipMethods":"Shipping Options","chkoutPayOptions":"Payment Choices","chkoutOrderNotes":"Order Notes"},templates:["myCheckoutSpec","cartSummaryTotalsSpec","checkoutSuccess","chkout-billAddressSpec","chkout-shipAddressSpec","chkout-orderNotesSpec","chkout-cartSummarySpec","chkout-shipMethodsSpec","checkout-payOptionsSpec","chkout-accountInfoSpec","zCheckoutContainerSpec"]},calls:{startCheckout:{init:function(containerID){var r=0;myControl.ext.convertSessionToOrder.vars.containerID=containerID;$('#'+containerID).append(myControl.renderFunctions.createTemplateInstance('zCheckoutContainerSpec','zCheckoutContainer'));myControl.renderFunctions.translateTemplate({},'zCheckoutContainer');r=myControl.ext.convertSessionToOrder.calls.showCheckoutForm.init();myControl.model.dispatchThis("immutable");if(myControl.sharedCheckoutUtilities.determineAuthentication()=='authenticated'){myControl.util.dump(" -> user is logged in. set account creation hidden input to 0");$('#chkout-create_customer').val(0);}
_gaq.push(['_trackEvent','Checkout','App Event','Checkout Initiated']);return r;}},cartShippingMethodsWithUpdate:{init:function(callback){this.dispatch(callback);return 1;},dispatch:function(callback){myControl.model.addDispatchToQ({"_cmd":"cartShippingMethods","update":"1","trace":"1","_tag":{"datapointer":"cartShippingMethods","callback":callback,"extension":"convertSessionToOrder"}},'immutable');}},buyerAddressList:{init:function(callback){this.dispatch(callback);return 1;},dispatch:function(callback){myControl.model.addDispatchToQ({"_cmd":"buyerAddressList","_tag":{"datapointer":"buyerAddressList","callback":callback,"extension":"convertSessionToOrder"}},'immutable');}},appCheckoutDestinations:{init:function(callback){this.dispatch(callback);return 1;},dispatch:function(callback){myControl.model.addDispatchToQ({"_cmd":"appCheckoutDestinations","_tag":{"datapointer":"appCheckoutDestinations","callback":callback,"extension":"convertSessionToOrder"}},'immutable');}},appPaymentMethods:{init:function(callback){this.dispatch(callback);return 1;},dispatch:function(callback){var total;var country='';myControl.model.fetchData('cartItemsList');if(!$.isEmptyObject(myControl.data.cartItemsList)){total=myControl.data.cartItemsList.cart['data.balance_due'];}
if(!$.isEmptyObject(myControl.data.cartItemsList)&&myControl.data.cartItemsList['data.bill_country']){country=myControl.data.cartItemsList['data.bill_country'];}
myControl.model.addDispatchToQ({"_cmd":"appPaymentMethods","_tag":{"datapointer":"appPaymentMethods","callback":callback,"extension":"convertSessionToOrder"},"country":country,"ordertotal":total},'immutable');}},getCartContents:{init:function(callback){this.dispatch(callback);return 1;},dispatch:function(callback){myControl.model.addDispatchToQ({"_cmd":"cartItemsList","_zjsid":myControl.sessionId,"_tag":{"datapointer":"cartItemsList","callback":callback,"extension":"convertSessionToOrder"}},'immutable');}},cartGiftcardAdd:{init:function(giftcard,callback){this.dispatch(giftcard,callback);},dispatch:function(giftcard,callback){myControl.model.addDispatchToQ({"_cmd":"cartGiftcardAdd","giftcard":giftcard,"_tag":{"callback":callback,"extension":"convertSessionToOrder"}},'immutable');}},cartCouponAdd:{init:function(coupon,callback){this.dispatch(coupon,callback);},dispatch:function(coupon,callback){myControl.model.addDispatchToQ({"_cmd":"cartCouponAdd","coupon":coupon,"_tag":{"callback":callback,"extension":"convertSessionToOrder"}},'immutable');}},saveCheckoutFields:{init:function(callback){this.dispatch(callback);return 1;},dispatch:function(callback){myControl.calls.cartSet.init($('#zCheckoutFrm').serializeJSON());}},showCheckoutForm:{init:function(){myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutPreflight');$('#chkoutSummaryErrors').empty();return this.dispatch();;},dispatch:function(){var r=5;if((zGlobals.globalSettings.inv_mode*1)>0){r+=myControl.ext.convertSessionToOrder.calls.cartItemsInventoryVerify.init("handleInventoryUpdate");}
myControl.ext.convertSessionToOrder.calls.appPaymentMethods.init();if(myControl.sharedCheckoutUtilities.determineAuthentication()=='authenticated'){myControl.ext.convertSessionToOrder.calls.buyerAddressList.init();}
myControl.ext.convertSessionToOrder.calls.appCheckoutDestinations.init();myControl.ext.convertSessionToOrder.calls.cartShippingMethodsWithUpdate.init();myControl.ext.convertSessionToOrder.calls.getCartContents.init("loadPanelContent");return r;}},cartOrderCreate:{init:function(callback){this.dispatch(callback);return 1;},dispatch:function(callback){var payObj={};_gaq.push(['_trackEvent','Checkout','App Event','Attempting to create order']);payObj['payment.cc']=myControl.ext.convertSessionToOrder.vars["payment.cc"];payObj['payment.cv']=myControl.ext.convertSessionToOrder.vars["payment.cv"];payObj['payment.yy']=myControl.ext.convertSessionToOrder.vars["payment.yy"];payObj['payment.mm']=myControl.ext.convertSessionToOrder.vars["payment.mm"];payObj['_cmd']='cartOrderCreate';payObj['_tag']={"callback":callback,"extension":"convertSessionToOrder","datapointer":"cartOrderCreate"}
myControl.util.dump("PayObj to follow:");myControl.util.dump(payObj);myControl.model.addDispatchToQ(payObj,'immutable');}},processCheckout:{init:function(callback){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.calls.processCheckout.init');$('#chkoutSummaryErrors').empty();$('#chkoutPlaceOrderBtn').attr('disabled','disabled').addClass('ui-state-disabled loadingButtonBg');var checkoutIsValid=myControl.ext.convertSessionToOrder.validate.isValid();myControl.util.dump(' -> checkoutIsValid = '+checkoutIsValid);var serializedCheckout=$('#zCheckoutFrm').serializeJSON()
if(!checkoutIsValid){serializedCheckout['payment.cc']='';serializedCheckout['payment.cv']='';}
myControl.calls.cartSet.init(serializedCheckout);if(checkoutIsValid){this.dispatch(callback);myControl.util.dump(" -> !!! got to valid checkout and adding to dispatchQ. Why isn't there a dispatch here?");}
else{$('#chkoutPlaceOrderBtn').attr('disabled',false).removeClass('ui-state-disabled').removeClass('loadingButtonBg');myControl.util.jumpToAnchor('chkoutSummaryErrors');}
_gaq.push(['_trackEvent','Checkout','User Event','Create order button pushed (validated = '+checkoutIsValid+')']);return 1;},dispatch:function(callback){myControl.model.addDispatchToQ({"_cmd":"cartCheckoutValidate","_tag":{"callback":callback,"extension":"convertSessionToOrder"}},'immutable');}},cartItemsInventoryVerify:{init:function(callback){this.dispatch(callback);return 1;},dispatch:function(callback){myControl.model.addDispatchToQ({"_cmd":"cartItemsInventoryVerify","_tag":{"datapointer":"cartItemsInventoryVerify","callback":callback,"extension":"convertSessionToOrder"}},'immutable');}}},callbacks:{init:{onSuccess:function(){var r;if(!zGlobals||$.isEmptyObject(zGlobals.checkoutSettings)){$('#globalMessaging').toggle(true).append(myControl.util.formatMessage({'message':'<strong>Uh Oh!<\/strong> It appears an error occured. Please try again. If error persists, please contact the site administrator.','uiClass':'error','uiIcon':'alert'}));r=false;}
else if(zGlobals.checkoutSettings.preference_require_login==1){myControl.util.dump(" -> zGlobals.checkoutSettings.preference_require_login == 1");$('#globalMessaging').toggle(true).append(myControl.util.formatMessage({'message':'<strong>Uh Oh!<\/strong> There appears to be an issue with the store configuration. Please change your checkout setting to \'nice\' if you wish to use this layout.','uiClass':'error','uiIcon':'alert'}));r=false;}
else if(zGlobals.checkoutSettings.preference_request_login==0){myControl.util.dump(" -> zGlobals.checkoutSettings.preference_request_login == 0");$('#globalMessaging').toggle(true).append(myControl.util.formatMessage({'message':'<strong>Uh Oh!<\/strong> There appears to be an issue with the store configuration. Please change your checkout setting to \'nice\' if you wish to use this layout.','uiClass':'error','uiIcon':'alert'}));r=false;}
else if(typeof _gaq==='undefined'){myControl.util.dump(" -> _gaq is undefined");$('#globalMessaging').toggle(true).append(myControl.util.formatMessage({'message':'<strong>Uh Oh!<\/strong> It appears you are not using the Asynchronous version of Google Analytics. It is required to use this checkout.','uiClass':'error','uiIcon':'alert'}));r=false;}
else if(myControl.util.getParameterByName('_testharness')){$('#globalMessaging').toggle(true).append(myControl.util.formatMessage({'message':'<strong>Excellent!<\/strong> Your store meets the requirements to use this one page checkout extension.','uiIcon':'circle-check','uiClass':'success'}));$('#'+myControl.ext.convertSessionToOrder.vars.containerID).removeClass('loadingBG').append("");}
else{r=true;}
if(r==false){this.onError();}
return r;},onError:function(){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.callbacks.init.error');$('#'+myControl.ext.convertSessionToOrder.vars.containerID).removeClass('loadingBG');}},startCheckout:{onSuccess:function(){myControl.ext.convertSessionToOrder.calls.startCheckout.init('zContent');},onError:function(){}},updateCheckoutShipMethods:{onSuccess:function(tagObj){myControl.ext.convertSessionToOrder.panelContent.shipMethods();},onError:function(d){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.callbacks.updateCheckoutShipMethods.onError - ERROR!');myControl.ext.convertSessionToOrder.panelContent.shipMethods();$('#chkoutShipMethodsFieldsetErrors').append(myControl.util.getResponseErrors(d)).toggle(true);}},addGiftcardToCart:{onSuccess:function(tagObj){myControl.util.dump('got to addGiftcardToCart success');myControl.ext.convertSessionToOrder.panelContent.cartContents();myControl.ext.convertSessionToOrder.panelContent.paymentOptions();$('#giftcardMessaging').empty().append(myControl.util.formatMessage({'message':'Your gift card has been added. Your cart summary has been updated.','uiIcon':'check','htmlid':'giftcardSuccessMessage','timeoutFunction':"$('#giftcardSuccessMessage').slideUp(1000);"}));_gaq.push(['_trackEvent','Checkout','User Event','Cart updated - giftcard added']);},onError:function(d){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.callbacks.addGiftcardToCart.onError - ERROR!');myControl.ext.convertSessionToOrder.panelContent.paymentOptions();$('#chkoutPayOptionsFieldsetErrors').append(myControl.util.getResponseErrors(d)).toggle(true);}},addCouponToCart:{onSuccess:function(tagObj){myControl.util.dump('BEGIN control.ext.convertSessionToOrder.callbacks.addcouponToCart.onSuccess');$('#addCouponBtn').removeAttr('disabled').removeClass('ui-state-disabled').removeClass('loadingButtonBg');$('#couponMessaging').empty().toggle(true).append(myControl.util.formatMessage({'message':'Your coupon has been added.','uiClass':'success','uiIcon':'check','htmlid':'couponSuccessMessage','timeoutFunction':"$('#couponSuccessMessage').slideUp(1000);"}));_gaq.push(['_trackEvent','Checkout','User Event','Cart updated - coupon added']);},onError:function(d){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.callbacks.addcouponToCart.onError');$('#addCouponBtn').removeAttr('disabled').removeClass('ui-state-disabled').removeClass('loadingButtonBg');$('#couponMessaging').empty().toggle(true).append(myControl.util.getResponseErrors(d));}},handleInventoryUpdate:{onSuccess:function(tagObj){var r=false;if(!$.isEmptyObject(myControl.data[tagObj.datapointer])&&!$.isEmptyObject(myControl.data[tagObj.datapointer]['%changes'])){myControl.util.dump(' -> adjustments are present');r="<div id='inventoryErrors'>It appears that some inventory adjustments needed to be made:<ul>";for(var key in myControl.data[tagObj.datapointer]['%changes']){r+="<li>sku: "+key+" was set to "+myControl.data[tagObj.datapointer]['%changes'][key]+" due to availability<\/li>";myControl.calls.updateCartContents.init({"stid":key,"quantity":myControl.data[tagObj.datapointer]['%changes'][key]});}
r+="<\/ul><\/div>";$('#globalMessaging').toggle(true).append(myControl.util.formatMessage({'message':r,'uiIcon':'alert'}));}
_gaq.push(['_trackEvent','Checkout','App Event','Cart updated - inventory adjusted to reflect availability']);return r;},onError:function(d){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.callbacks.handleInventoryUpdate.onError - ERROR!');myControl.ext.convertSessionToOrder.panelContent.paymentOptions();$('#globalMessaging').append(myControl.util.getResponseErrors(d)).toggle(true);}},updateCheckoutPayOptions:{onSuccess:function(tagObj){myControl.ext.convertSessionToOrder.panelContent.paymentOptions();},onError:function(d){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.callbacks.updateCheckoutPayOptions.onError - ERROR!');myControl.ext.convertSessionToOrder.panelContent.paymentOptions();$('#chkoutPayOptionsFieldsetErrors').append(myControl.util.getResponseErrors(d)).toggle(true);}},updateCheckoutOrderContents:{onSuccess:function(){myControl.ext.convertSessionToOrder.panelContent.cartContents();},onError:function(d){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.callbacks.updateCheckoutOrderContents.onError - ERROR!');myControl.ext.convertSessionToOrder.panelContent.cartContents();$('#chkoutSummaryErrors').append(myControl.util.getResponseErrors(d)).toggle(true);}},finishedValidatingCheckout:{onSuccess:function(tagObj){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.callbacks.finishedValidatingCheckout.onSuccess');myControl.ext.convertSessionToOrder.calls.cartOrderCreate.init("checkoutSuccess");myControl.model.dispatchThis('immutable');_gaq.push(['_trackEvent','Checkout','App Event','Server side validation passed']);},onError:function(responseData,uuid){$('#chkoutPlaceOrderBtn').removeAttr('disabled').removeClass('ui-state-disabled loadingButtonBg');responseData['_rtag']=$.isEmptyObject(responseData['_rtag'])?{}:responseData['_rtag'];responseData['_rtag'].targetID='chkoutSummaryErrors';myControl.ext.convertSessionToOrder.utilities.showServerErrors(responseData,uuid);_gaq.push(['_trackEvent','Checkout','App Event','Server side validation failed']);}},loadPanelContent:{onSuccess:function(tagObj){var stuffCount=myControl.model.countProperties(myControl.data.cartItemsList.cart.stuff);if(stuffCount>0){myControl.ext.convertSessionToOrder.panelContent.preflight();if(myControl.sharedCheckoutUtilities.determineAuthentication()!='none'){myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutAccountInfo');myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutBillAddress');myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutShipAddress',Number(myControl.data.cartItemsList.cart['chkout.bill_to_ship'])==0?false:true)
myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutShipMethods');myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutPayOptions');myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutOrderNotes',true);myControl.ext.convertSessionToOrder.panelContent.cartContents();myControl.ext.convertSessionToOrder.panelContent.billAddress();myControl.ext.convertSessionToOrder.panelContent.accountInfo();myControl.ext.convertSessionToOrder.panelContent.shipAddress();myControl.ext.convertSessionToOrder.panelContent.shipMethods();myControl.ext.convertSessionToOrder.panelContent.paymentOptions();if(zGlobals.checkoutSettings.chkout_order_notes==true){myControl.ext.convertSessionToOrder.panelContent.orderNotes();$('#chkoutOrderNotes').toggle(true);}
_gaq.push(['_trackEvent','Checkout','Milestone','Valid email address obtained']);}
else{myControl.util.dump(' -> authentication == none. panels not displayed (except preflight)');}}
else{myControl.ext.convertSessionToOrder.utilities.cartIsEmptyWarning();}
$('#'+myControl.ext.convertSessionToOrder.vars.containerID).removeClass('loadingBG');},onError:function(d){$('#globalMessaging').append({"message":"It appears something has gone very wrong. Please try again. If error persists, please contact the site administrator.","uiClass":"error","uiIcon":"alert"})
$('#globalMessaging').append(myControl.util.getResponseErrors(d)).toggle(true);}},checkoutSuccess:{onSuccess:function(tagObj){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.callbacks.checkoutSuccess.onSuccess   datapointer = '+tagObj.datapointer);var $zContent=$('#'+myControl.ext.convertSessionToOrder.vars.containerID).empty();var oldSession=myControl.sessionId;var orderID=myControl.data[tagObj.datapointer].orderid;myControl.util.jumpToAnchor(myControl.ext.convertSessionToOrder.vars.containerID);$zContent.append(myControl.renderFunctions.createTemplateInstance('checkoutSuccess','checkoutSuccessContent'));myControl.renderFunctions.translateTemplate(myControl.data[tagObj.datapointer],'checkoutSuccessContent');$('.paymentRequired').append(myControl.data[tagObj.datapointer].payment_status_detail);var cartContentsAsLinks=encodeURI(myControl.ext.convertSessionToOrder.utilities.cartContentsAsLinks('order|'+orderID))
$('.ocmTwitterComment').click(function(){window.open('http://twitter.com/home?status='+cartContentsAsLinks,'twitter');_gaq.push(['_trackEvent','Checkout','User Event','Tweeted about order']);});$('.ocmFacebookComment').click(function(){myControl.thirdParty.fb.postToWall(cartContentsAsLinks);_gaq.push(['_trackEvent','Checkout','User Event','FB message about order']);});myControl.calls.appCartCreate.init();myControl.ext.convertSessionToOrder.calls.getCartContents.init();myControl.model.dispatchThis('immutable');$zContent.append(myControl.data[tagObj.datapointer]['html:roi']);_gaq.push(['_trackEvent','Checkout','App Event','Order created']);_gaq.push(['_trackEvent','Checkout','User Event','Order created ('+orderID+')']);},onError:function(responseData,uuid){$('#chkoutPlaceOrderBtn').removeAttr('disabled').removeClass('ui-state-disabled loadingButtonBg');responseData['_rtag']=$.isEmptyObject(responseData['_rtag'])?{}:responseData['_rtag'];responseData['_rtag'].targetID='chkoutSummaryErrors';myControl.ext.convertSessionToOrder.utilities.showServerErrors(responseData,uuid);_gaq.push(['_trackEvent','Checkout','App Event','Order NOT created. error occured. ('+d['_msg_1_id']+')']);}}},validate:{isValid:function(){var $globalErrors=$('#chkoutSummaryErrors').empty().toggle(false);var r=true;var sum=0;sum+=this.chkoutPreflightFieldset();sum+=this.chkoutShipMethodsFieldset();sum+=this.chkoutPayOptionsFieldset();sum+=this.chkoutBillAddressFieldset();sum+=this.chkoutShipAddressFieldset();sum+=this.chkoutAccountInfoFieldset();if(sum!=6){r=false;$globalErrors.append(myControl.util.formatMessage({"message":"Some required fields were left blank or contained errors. (please scroll up)","uiClass":"error","uiIcon":"alert"})).toggle(true);}
return r;},chkoutPreflightFieldset:function(){var valid=1;var $errorDiv=$('#chkoutPreflightFieldsetErrors').empty().toggle(false);if(myControl.sharedCheckoutUtilities.determineAuthentication()!='authenticated'){var $email=$('#data-bill_email');if($email.val()==''){$email.addClass('mandatory');$errorDiv.append(myControl.util.formatMessage("Please provide an email address")).toggle(true);myControl.ext.convertSessionToOrder.vars.validPreflight=0;$('#chkoutPreflightFieldset').removeClass('validatedFieldset');valid=0;}
else if(!myControl.util.isValidEmail($email.val())){$errorDiv.append(myControl.util.formatMessage("An invalid email address was used, please try again.")).toggle(true);$email.addClass('mandatory');$('#chkoutPreflightFieldset').removeClass('validatedFieldset');valid=0;}
else{$email.removeClass('mandatory');$('#chkoutPreflightFieldset').addClass('validatedFieldset');}}
else{myControl.util.dump(' -> did not validate preflight panel because user is authenticated. authentication = '+myControl.sharedCheckoutUtilities.determineAuthentication());}
return valid;},chkoutOrderNotesFieldset:function(){},chkoutAccountInfoFieldset:function(){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.validation.chkoutAccountInfoFieldset');var valid=1;var $fieldsetErrors=$('#chkoutAccountInfoFieldsetErrors').empty().toggle(false);var authState=myControl.sharedCheckoutUtilities.determineAuthentication();myControl.util.dump('authState = '+authState);if(authState=='authenticated'||authState=='thirdPartyGuest'){myControl.util.dump(' -> user is logged in, authentication not needed.');$('#chkout-create_customer').val("0");}
else if($('#chkout-create_customer').val()==0){myControl.util.dump(' -> create account disabled or not available.');}
else{myControl.util.dump(' -> create account enabled. validating...');var errMsg="";var $pass=$('#chkout-new_password')
var $pass2=$('#chkout-new_password2');var $hintQ=$('#chkout-recovery_hint');var $hintA=$('#chkout-recovery_answer');$pass.parent().removeClass('mandatory');$pass2.parent().removeClass('mandatory');$hintQ.parent().removeClass('mandatory');$hintA.parent().removeClass('mandatory');if(!$pass.val()||$pass.val().length<8){valid=0;$pass.parent().addClass('mandatory');$pass2.parent().addClass('mandatory');errMsg+='<li>Please enter a password of at least 8 characters<\/li>';}
else if($pass.val()!=$pass2.val()){valid=0;errMsg+='<li>Your password and verify password do not match<\/li>';}
if(!$hintQ.val()){valid=0;$hintQ.parent().addClass('mandatory');errMsg+='<li>Please select a recovery question <span class="zhint">(in case you need to recover your password)<\/span><\/li>';}
if(!$hintA.val()){valid=0;$hintA.parent().addClass('mandatory');errMsg+='<li>Please select a recovery answer <\/li>';}
if(valid==0){$fieldsetErrors.toggle(true).append(myControl.util.formatMessage("<ul>"+errMsg+"<\/ul>"));}}
return valid;},chkoutShipMethodsFieldset:function(){var valid=1;var $shipMethod=$("[name='ship.selected_id']:checked");$('#chkoutShipMethodsFieldsetErrors').empty().toggle(false);if($shipMethod.val()){$('#chkoutShipMethodsFieldset').addClass('validatedFieldset');}
else{valid=0;$('#chkoutShipMethodsFieldsetErrors').toggle(true).append(myControl.util.formatMessage("Please select a shipping method."));$('#chkoutShipMethodsFieldset').removeClass('validatedFieldset');}
if(valid==1){_gaq.push(['_trackEvent','Checkout','Milestone','Shipping method validated']);}
return valid;},chkoutPayOptionsFieldset:function(){var valid=1;var $payMethod=$("[name='chkout.payby']:checked");var $errorDiv=$('#chkoutPayOptionsFieldsetErrors').empty().toggle(false);var errMsg='';var safeid,$holder;if($payMethod.val()){switch($payMethod.val()){case'CREDIT':var $paymentCC=$('#payment-cc').removeClass('mandatory');var $paymentMM=$('#payment-mm').removeClass('mandatory');var $paymentYY=$('#payment-yy').removeClass('mandatory');var $paymentCV=$('#payment-cv').removeClass('mandatory');if(!myControl.util.isValidCC($paymentCC.val())){$paymentCC.parent().addClass('mandatory');valid=0;errMsg+='<li>please enter a valid credit card #<\/li>'}
if(!myControl.util.isValidMonth($paymentMM.val())){$paymentMM.parent().addClass('mandatory');valid=0;errMsg+='<li>please select an exipration month<\/li>'}
if(!myControl.util.isValidCCYear($paymentYY.val())){$paymentYY.parent().addClass('mandatory');valid=0;errMsg+='<li>please select an expiration year<\/li>'}
if($paymentCV.val().length<3){$paymentCV.parent().addClass('mandatory');valid=0;errMsg+='<li>please enter a cvv/cid #<\/li>'}
break;case'ECHECK':for(var key in myControl.ext.convertSessionToOrder.vars.echeck){$holder=$('#'+myControl.util.makeSafeHTMLId(key)).removeClass('mandatory');if(!$holder.val()){$holder.parent().addClass('mandatory');valid=0;errMsg+='<li>please enter a '+myControl.ext.convertSessionToOrder.vars.echeck[key]+'<\/li>'}}
break;case'PO':var $paymentPO=$('#payment-po').removeClass('mandatory');if(!myControl.util.isSet($paymentPO.val())){$paymentPO.parent().addClass('mandatory');valid=0;errMsg+='<li>please enter a PO #<\/li>'}
break;default:break;}
errMsg="Some required fields are missing/invalid:<ul>"+errMsg+"<\/ul>"}
else{valid=0;errMsg='please select a payment method';}
if(valid==0){$('#chkoutPayOptionsFieldset').removeClass('validatedFieldset');$errorDiv.toggle(true).append(myControl.util.formatMessage(errMsg));}
else{$('#chkoutPayOptionsFieldset').addClass('validatedFieldset');_gaq.push(['_trackEvent','Checkout','Milestone','Payment method validated ('+$payMethod.val()+')']);}
return valid;},chkoutBillAddressFieldset:function(){var valid=1;var r=true;$('#chkoutBillAddressFieldsetErrors').empty().toggle(false);$('#chkoutBillAddressFieldset .mandatory').removeClass('mandatory');r=this.addressIsPopulated('bill');if(r){$('#chkoutBillAddressFieldset').addClass('validatedFieldset');}
else{valid=0;$('#chkoutBillAddressFieldsetErrors').append(myControl.util.formatMessage("Some required fields were left blank or are invalid")).toggle(true);$('#chkoutBillAddressFieldset').removeClass('validatedFieldset');$("#billAddressUL").toggle(true);}
if(valid==1){_gaq.push(['_trackEvent','Checkout','Milestone','billing address obtained']);}
return valid;},chkoutShipAddressFieldset:function(){var valid=1;var r=true;$('#chkoutShipAddressFieldsetErrors').empty().toggle(false);$('#chkoutShipAddressFieldset .mandatory').removeClass('mandatory');if($('#chkout-bill_to_ship_cb').is(':checked')){myControl.sharedCheckoutUtilities.setShipAddressToBillAddress();}
else{r=this.addressIsPopulated('ship');}
if(r){$('#chkoutShipAddressFieldset').addClass('validatedFieldset');}
else{valid=0;$('#chkoutShipAddressFieldsetErrors').append(myControl.util.formatMessage("Some required fields were left blank or are invalid")).toggle(true);$('#chkoutShipAddressFieldset').removeClass('validatedFieldset');$("#shipAddressUL").toggle(true);}
if(valid==1){_gaq.push(['_trackEvent','Checkout','Milestone','shipping address obtained']);}
return valid;},addressIsPopulated:function(TYPE){var r=true;var $errorDiv=TYPE=="bill"?$('#chkoutBillAddressFieldsetErrors'):$('#chkoutShipAddressFieldsetErrors');var $firstName=$('#data-'+TYPE+'_firstname').removeClass('mandatory');var $lastName=$('#data-'+TYPE+'_lastname').removeClass('mandatory');var $address1=$('#data-'+TYPE+'_address1').removeClass('mandatory');var $city=$('#data-'+TYPE+'_city').removeClass('mandatory');var $state=$('#data-'+TYPE+'_state').removeClass('mandatory');var $zip=$('#data-'+TYPE+'_zip').removeClass('mandatory');var $country=$('#data-'+TYPE+'_country').removeClass('mandatory');if($firstName.val().length<2){$firstName.parent().addClass('mandatory');r=false;}
if($lastName.val().length<2){$lastName.parent().addClass('mandatory');r=false;}
if($address1.val().length<2){$address1.parent().addClass('mandatory');r=false;}
if($city.val().length<2){$city.parent().addClass('mandatory');r=false;}
if($state.val().length<2){$state.parent().addClass('mandatory');r=false;}
if(zGlobals.checkoutSettings.chkout_phone=='REQUIRED'){var $phone=$('#data-'+TYPE+'_phone').removeClass('mandatory');if(myControl.util.isValidPhoneNumber($phone.val(),$country.val())==true){}
else if(TYPE=='ship'&&($('#data-bill_phone').val())){$phone.val($('#data-bill_phone').val())}
else{$errorDiv.append(myControl.util.formatMessage("Please provide a valid phone number with area code."));$phone.parent().addClass('mandatory');r=false;}}
if(!myControl.util.isValidPostalCode($zip.val(),$country.val())){$zip.parent().addClass('mandatory');r=false;}
return r;}},panelContent:{preflight:function(){var username=myControl.util.getUsernameFromCart();var className='';var o;var authState=myControl.sharedCheckoutUtilities.determineAuthentication();var email='';if(myControl.data.cartItemsList.cart['data.bill_email']){email=myControl.data.cartItemsList.cart['data.bill_email'];}
else if(username&&myControl.util.isValidEmail(username)){email=username;}
if(authState=='authenticated'){o="<ul id='preflightAuthenticatedInputs' class='noPadOrMargin noListStyle'>";o+="<li><label class='prompt'>Username<\/label><span class='value'>"+username+"<\/span><\/li>";o+="<input type='hidden'   name='data.bill_email' id='data-bill_email' value='"+email+"' /><\/ul>";}
else{o="<div id='preflightGuestInputs' class='preflightInputContainer'><h2>Guest Checkout<\/h2><div><label for='data.bill_email'>Email<\/label>";o+="<input type='email'   name='data.bill_email' id='data-bill_email' value='"+email+"' onkeypress='if (event.keyCode==13){$(\"#guestCheckoutBtn\").click();}' />";o+="<button class='ui-state-default ui-corner-all' onClick='myControl.ext.convertSessionToOrder.utilities.handleGuestEmail($(\"#data-bill_email\").val());' id='guestCheckoutBtn'>"
o+=authState=='guest'||authState=='thirdPartyGuest'?'Update Email':'Next';o+="<\/button><\/div>";if(authState=='guest'){o+="<div class='floatRight'><a href='#' onClick='$(\"#preflightAccountInputs\").toggle(true); return false;' class='login'>Click here to log in<\/a><\/div>";o+="<div id='chkout-create_customerContainer'><input  type='checkbox' checked='checked' value='1' onClick=\"myControl.ext.convertSessionToOrder.utilities.handleCreateAccountCheckbox(this.checked?1:0);\" name='chkout.create_customer_cb' id='chkout-create_customer_cb' \/> <label for='chkout-create_customer_cb'>Create Customer Account<\/label><\/div>"}
o+="<\/div>";if(authState!='none')
className='displayNone';o+="<div id='preflightAccountInputs' class='"+className+" preflightInputContainer'><h2>Existing Users<\/h2>";o+="<div><label for='data.bill_email2'>Email<\/label><input type='email'   name='data.bill_email' id='data-bill_email2' value='"+email+"' /><\/div>";o+="<div><label for='chkout-password'>Password<\/label><input type='password'  name='password' id='chkout-password' value='' onkeypress='if (event.keyCode==13){$(\"#userLoginBtn\").click();}' />";o+="<button  class='ui-state-default ui-corner-all' onClick='myControl.ext.convertSessionToOrder.utilities.handleUserLogin($(\"#data-bill_email2\").val(),$(\"#chkout-password\").val());' id='userLoginBtn'>Log in<\/button><\/div><\/div>";if(authState!='thirdPartyGuest'&&zGlobals.thirdParty.facebook.appId)
o+="<div id='preflightThirdParty' class='"+className+" preflightInputContainer'><h2>Third Party Login<\/h2><fb:login-button onlogin='myControl.calls.authentication.facebook.init({\"callback\":\"authenticateThirdParty\",\"extension\":\"convertSessionToOrder\"}); myControl.model.dispatchThis(\"immutable\");'>Login with Facebook</fb:login-button><\/div>";}
var $fieldset=$("#chkoutPreflightFieldset").toggle(true);$fieldset.removeClass("loadingBG").append(o);FB.init({appId:zGlobals.thirdParty.facebook.appId,cookie:true,status:true,xfbml:true});},accountInfo:function(){var authState=myControl.sharedCheckoutUtilities.determineAuthentication();var createCustomer=myControl.data.cartItemsList.cart['chkout.create_customer']?myControl.data.cartItemsList.cart['chkout.create_customer']:0;if(authState=='authenticated'||authState=='thirdPartyGuest'){createCustomer=0;$('#chkoutAccountInfoFieldset').toggle(false);}
else{if(createCustomer==0){$("#chkout-create_customer_cb").removeAttr('checked');$('#chkoutAccountInfoFieldset').toggle(false);}
else{$('#chkoutAccountInfoFieldset').toggle(true);}
var o="";var $panelFieldset=$("#chkoutAccountInfoFieldset").removeClass("loadingBG")
$panelFieldset.append(myControl.renderFunctions.createTemplateInstance('chkout-accountInfoSpec','accountInfoContainer'));myControl.renderFunctions.translateTemplate(myControl.data.cartItemsList.cart,'accountInfoContainer');$('#chkout-create_customer').val(createCustomer);}},billAddress:function(){var data=myControl.data.cartItemsList.cart;var txt='';var cssClass;var authState=myControl.sharedCheckoutUtilities.determineAuthentication();if(authState=='authenticated'&&myControl.ext.convertSessionToOrder.utilities.addressListOptions('bill')!=false){txt="Please choose from (click on) billing address(es) below:";txt+=myControl.ext.convertSessionToOrder.utilities.addressListOptions('bill');cssClass='displayNone';}
var $panelFieldset=$("#chkoutBillAddressFieldset").removeClass("loadingBG").append("<p>"+txt+"<\/p>");$panelFieldset.append(myControl.renderFunctions.createTemplateInstance('chkout-billAddressSpec','billAddressUL'));myControl.renderFunctions.translateTemplate(myControl.data.cartItemsList.cart,'billAddressUL');$('#billAddressUL').addClass(cssClass);if(authState=='authenticated'&&myControl.ext.convertSessionToOrder.utilities.addressListOptions('ship')!=false){$("#chkout-bill_to_ship_cb").removeAttr("checked");$("#chkout-bill_to_ship").val('0');$("#chkout-bill_to_ship_cb_container").toggle(false);}
else if(myControl.data.cartItemsList.cart['chkout.bill_to_ship']*1==0){$("#chkout-bill_to_ship_cb").removeAttr("checked");$("#chkout-bill_to_ship").val('0');}
else{$("#chkout-bill_to_ship").val('1');$("#chkout-bill_to_ship_cb").attr("checked","checked");}
if(myControl.data.appCheckoutDestinations['@destinations'].length<2)
$('#billCountryContainer').toggle(false);},shipAddress:function(){var txt='';var cssClass='';var $panelFieldset=$("#chkoutShipAddressFieldset");if(myControl.sharedCheckoutUtilities.determineAuthentication()=='authenticated'&&myControl.ext.convertSessionToOrder.utilities.addressListOptions('ship')!=false){myControl.util.dump(' -> user is authenticated and has predefined shipping addressses.');$panelFieldset.toggle(true);txt="<p>Please choose from (click on) shipping address(es) below:<\/p>";txt+=myControl.ext.convertSessionToOrder.utilities.addressListOptions('ship');cssClass='displayNone';}
$panelFieldset.removeClass('loadingBG').append(txt);$panelFieldset.append(myControl.renderFunctions.createTemplateInstance('chkout-shipAddressSpec','shipAddressUL'));myControl.renderFunctions.translateTemplate(myControl.data.cartItemsList.cart,'shipAddressUL');$('#shipAddressUL').addClass(cssClass);if(myControl.data.appCheckoutDestinations['@destinations'].length<2)
$('#shipCountryContainer').toggle(false);},shipMethods:function(){var $panelFieldset=$("#chkoutShipMethodsFieldset").removeClass("loadingBG");$panelFieldset.append(myControl.renderFunctions.createTemplateInstance('chkout-shipMethodsSpec','shipMethodsContainer'));myControl.renderFunctions.translateTemplate(myControl.data.cartShippingMethods,'shipMethodsContainer');if(myControl.data.cartShippingMethods['@methods'].length==0){$('#noShipMethodsAvailable').toggle(true);}
else if(!$('#data-bill_zip').val()&&!$('ship_zip').val()){$('#noZipShipMessage').toggle(true);}
var foundMatchingShipMethodId=false;var L=myControl.data.cartShippingMethods['@methods'].length;for(var i=0;i<L;i+=1){if(myControl.data.cartShippingMethods['@methods'][i].id==myControl.data.cartItemsList.cart['ship.selected_id']){foundMatchingShipMethodId=true;break;}}
if(foundMatchingShipMethodId==false){myControl.util.dump(' -> previously selected ship method is no longer available. update session with null value.');myControl.calls.cartSet.init({"ship.selected_id":null});myControl.ext.convertSessionToOrder.calls.getCartContents.init('updateCheckoutOrderContents');myControl.model.dispatchThis('immutable');}},cartContents:function(){var $container=$('#chkoutCartSummaryContainer').toggle(true);if($('#chkoutCartSummary').length==0){$container.append(myControl.renderFunctions.createTemplateInstance('chkout-cartSummarySpec','chkoutCartSummary'));myControl.renderFunctions.translateTemplate(myControl.data.cartItemsList.cart,'chkoutCartSummary');}
var $targetObj=$('#chkoutCartContents').removeClass("loadingBG").empty();var sku,stid,i;var L=myControl.data.cartItemsList.cart.stuff.length;for(i=0;i<L;i+=1){stid=myControl.data.cartItemsList.cart.stuff[i].stid
$targetObj.append(myControl.renderFunctions.createTemplateInstance('myCheckoutSpec','myCheckoutSpec_'+stid));myControl.renderFunctions.translateTemplate(myControl.data.cartItemsList.cart.stuff[i],'myCheckoutSpec_'+stid);}
$('#cartSummaryTotalsContainer').append(myControl.renderFunctions.createTemplateInstance('cartSummaryTotalsSpec','cartSummaryTotals'));myControl.renderFunctions.translateTemplate(myControl.data.cartItemsList.cart,'cartSummaryTotals');},paymentOptions:function(){var $panelFieldset=$("#chkoutPayOptionsFieldset").toggle(true).removeClass("loadingBG")
$panelFieldset.append(myControl.renderFunctions.createTemplateInstance('checkout-payOptionsSpec','payOptionsContainer'));myControl.renderFunctions.translateTemplate(myControl.data.appPaymentMethods,'payOptionsContainer');myControl.ext.convertSessionToOrder.utilities.updatePayDetails(myControl.data.cartItemsList.cart['chkout.payby']);},orderNotes:function(){var $panelFieldset=$("#chkoutOrderNotesFieldset").toggle(true).removeClass("loadingBG")
$panelFieldset.append(myControl.renderFunctions.createTemplateInstance('chkout-orderNotesSpec','orderNotesContainer'));myControl.renderFunctions.translateTemplate(myControl.data.cartItemsList.cart,'orderNotesContainer');}},utilities:{handleCouponSubmit:function(){$('#chkoutSummaryErrors').empty();$('#addCouponBtn').attr('disabled','disabled').addClass('ui-state-disabled loadingButtonBg');myControl.ext.convertSessionToOrder.calls.cartCouponAdd.init($('#couponCode').val(),'addCouponToCart');myControl.ext.convertSessionToOrder.calls.getCartContents.init('updateCheckoutOrderContents');myControl.model.dispatchThis('immutable');},handleGiftcardSubmit:function(){myControl.ext.convertSessionToOrder.calls.cartGiftcardAdd.init($('#giftcardCode').val(),'addGiftcardToCart');myControl.ext.convertSessionToOrder.calls.appPaymentMethods.init();myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutPayOptions');myControl.ext.convertSessionToOrder.calls.getCartContents.init('updateCheckoutOrderContents');myControl.model.dispatchThis('immutable');},addressListOptions:function(TYPE){var r='';var a;var parentDivId=TYPE=="bill"?'chkoutBillAddressFieldset':'chkoutShipAddressFieldset';var selAddress=false;if(!TYPE){r=false}
else if($.isEmptyObject(myControl.data.buyerAddressList)||$.isEmptyObject(myControl.data.buyerAddressList['@'+TYPE])){r=false}
else{if(myControl.util.isSet(myControl.data.cartItemsList.cart['data.selected_'+TYPE.toLowerCase()+'_id'])){selAddress=myControl.data.cartItemsList.cart['data.selected_'+TYPE.toLowerCase()+'_id'];}
else{selAddress=myControl.sharedCheckoutUtilities.fetchPreferredAddress(TYPE);}
var L=myControl.data.buyerAddressList['@'+TYPE].length;for(var i=0;i<L;i+=1){a=myControl.data.buyerAddressList['@'+TYPE][i];r+="<address class='pointer ui-state-default ";if(selAddress==a['_id']){r+=' ui-state-active';}
else if(a['_is_default']==1&&selAddress==false){r+=' ui-state-active ';}
r+="' data-addressClass='"+TYPE+"' data-addressId='"+a['_id']+"' onClick='myControl.ext.convertSessionToOrder.utilities.selectPredefinedAddress(this);' id='"+TYPE+"_address_"+a['_id']+"'>";r+=a[TYPE+'_firstname']+" "+a[TYPE+'_lastname']+"<br \/>";r+=a[TYPE+'_address1']+"<br \/>";if(a[TYPE+'_address2'])
r+=a[TYPE+'_address2']+"<br \/>";r+=a[TYPE+'_city'];if(a[TYPE+'_state'])
r+=" "+a[TYPE+'_state']+", ";if(a[TYPE+'_zip'])
r+=a[TYPE+'_zip']
if(myControl.util.isSet(a[TYPE+'_country']))
r+="<br \/>"+a[TYPE+'_country'];r+="<\/address>";}
r+="<address class='pointer' onClick='$(\"#"+TYPE+"AddressUL\").toggle(true); myControl.ext.convertSessionToOrder.utilities.removeClassFromChildAddresses(\""+parentDivId+"\");'>Enter new address or edit selected address<\/address>";r+="<div class='clearAll'><\/div>";}
return r;},cartContentsAsLinks:function(datapointer){var r="";var L=myControl.model.countProperties(myControl.data[datapointer].cart.stuff);for(var i=0;i<L;i+=1){if(myControl.data[datapointer].cart.stuff[i].sku[0]!='%'){r+="http://"+myControl.vars.sdomain+"/product/"+myControl.data[datapointer].cart.stuff[i].sku+"/\n";}}
return r;},cartIsEmptyWarning:function(){_gaq.push(['_trackEvent','Checkout','App Event','Empty Cart Message Displayed']);$('#'+myControl.ext.convertSessionToOrder.vars.containerID).empty().append("<p>It appears your cart is empty. If you think you are receiving this message in error, please contact the site administrator.<\/p>");},checkoutSuccessPaymentFailure:function(paycode,payby){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.utilities.checkoutSuccessPaymentFailure');myControl.util.dump(' -> paycode = '+paycode);myControl.util.dump(' -> payby = '+payby);var r;if(typeof paycode=='undefined'){switch(payby){case'CREDIT':r="There was a problem processing your credit card. Please contact us or click here for details.";break;default:r='Payment is still required for this order. Please click here for details.';}
_gaq.push(['_trackEvent','Checkout','User Event','Payment failure ('+payby+')']);_gaq.push(['_trackEvent','Checkout','App Event','Payment failure']);}
return r;},getProdDataForCartItems:function(){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.utilities.getProdDataForCartItems');var L=myControl.model.countProperties(myControl.data.cartItemsList.cart.stuff);myControl.util.dump(' -> # items in cart: '+L);for(i=0;i<L;i+=1){myControl.calls.getQuickProd('getProduct|'+myControl.data.cartItemsList.cart.stuff[i].sku);}},handleCreateAccountCheckbox:function(X){$('#chkout-create_customer').val(X);if(myControl.data.cartItemsList.cart["data.bill_email"]){X?$('#chkoutAccountInfoFieldset').toggle(true):$('#chkoutAccountInfoFieldset').toggle(false);}
myControl.calls.cartSet.init({"chkout.create_customer":X});myControl.calls.cartSet.init({"chkout.create_customer_cb":X});myControl.model.dispatchThis('immutable');},handleGuestEmail:function(email){$("#chkoutPreflightFieldsetErrors").empty().toggle(false);if(myControl.util.isValidEmail(email)==true){myControl.calls.cartSet.init({"data.bill_email":email});myControl.ext.convertSessionToOrder.calls.showCheckoutForm.init();myControl.model.dispatchThis('immutable');}
else{$("#chkoutPreflightFieldsetErrors").empty().toggle(true).append(myControl.util.formatMessage("please provide a valid email address"));}},handleUserLogin:function(email,password){var errors='';var $errorDiv=$("#chkoutPreflightFieldsetErrors").empty().toggle(false);if(myControl.util.isValidEmail(email)==false){errors+="<li>Please provide a valid email address<\/li>";}
if(!password){errors+="<li>Please provide your password<\/li>";}
if(errors==''){myControl.calls.authentication.zoovy.init({"login":email,"password":password},{'callback':'authenticateZoovyUser','extension':'convertSessionToOrder'});myControl.ext.convertSessionToOrder.calls.showCheckoutForm.init();myControl.model.dispatchThis('immutable');}
else{$errorDiv.toggle(true).append(myControl.util.formatMessage("<ul>"+errors+"<\/ul>"));}},updatePayDetails:function(paymentID){myControl.util.dump(" -> PAYID = "+paymentID);$('#chkoutPayOptionsFieldsetErrors').empty().hide();$('#chkout-payOptions li .paycon').removeClass('ui-state-active ui-corner-top ui-corner-bottom');$('#chkout-payOptions .paybySupplemental').hide();$('#payby_'+paymentID+' .paycon').addClass('ui-state-active ui-corner-top');$('#paybySupplemental_'+paymentID).show();var $selectedPayment=$('#paybySupplemental_'+paymentID);if($selectedPayment.length==0){$selectedPayment=$("<ul />").attr("id","paybySupplemental_"+paymentID).addClass("paybySupplemental noPadOrMargin noListStyle ui-widget-content ui-corner-bottom");$('#payby_'+paymentID).append($selectedPayment);var o='';var safeid;switch(paymentID){case'CREDIT':o="<li><label for='payment-cc'>Credit Card #<\/label><input type='text' size='20' name='payment.cc' id='payment-cc' class=' creditCard' value='";if(myControl.ext.convertSessionToOrder.vars['payment.cc']){o+=myControl.ext.convertSessionToOrder.vars['payment.cc']}
o+="' onKeyPress='return myControl.util.numbersOnly(event);' onChange='myControl.ext.convertSessionToOrder.vars[\"payment.cc\"] = this.value' /><\/li>";o+="<li><label>Expiration<\/label><select name='payment.mm' id='payment-mm' class='creditCardMonthExp' onChange='myControl.ext.convertSessionToOrder.vars[\"payment.mm\"] = this.value;'><option><\/option>";o+=myControl.util.getCCExpMonths(myControl.data.cartItemsList.cart['payment.mm']);o+="<\/select>";o+="<select name='payment.yy' id='payment-yy' class='creditCardYearExp' onChange='myControl.ext.convertSessionToOrder.vars[\"payment.yy\"] = this.value;'><option value=''><\/option>"+myControl.util.getCCExpYears(myControl.data.cartItemsList.cart['payment.yy'])+"<\/select><\/li>";o+="<li><label for='payment.cv'>CVV/CID<\/label><input type='text' size='8' name='payment.cv' id='payment-cv' class=' creditCardCVV' onKeyPress='return myControl.util.numbersOnly(event);' value='";if(myControl.ext.convertSessionToOrder.vars['payment.cv']){o+=myControl.ext.convertSessionToOrder.vars['payment.cv']}
o+="' onChange='myControl.ext.convertSessionToOrder.vars[\"payment.cv\"] = this.value' /><\/li>";break;case'PO':o="<li><label for='payment-po'>PO #<\/label><input type='text' size='2' name='payment.po' id='payment-po' class=' purchaseOrder' onChange='myControl.calls.cartSet.init({\"payment.po\":this.value});' value='";if(myControl.data.cartItemsList.cart['payment.po'])
o+=myControl.data.cartItemsList.cart['payment.po'];o+="' /><\/li>";break;case'ECHECK':for(var key in myControl.ext.convertSessionToOrder.vars.echeck){safeid=myControl.util.makeSafeHTMLId(key);o+="<li><label for='"+safeid+"'>"+myControl.ext.convertSessionToOrder.vars.echeck[key]+"<\/label><input type='text' size='2' name='"+key+"' id='"+safeid+"' class=' echeck' onChange='myControl.calls.cartSet.init({\""+key+"\":this.value});' value='";if(myControl.data.cartItemsList.cart[key])
o+=myControl.data.cartItemsList.cart[key];o+="' /><\/li>";}
break;default:$('#payby_'+paymentID+' .paycon').addClass('ui-corner-bottom');$('#paybySupplemental_'+paymentID).hide();o='';}
$selectedPayment.append(o);}
_gaq.push(['_trackEvent','Checkout','User Event','Payment method selected ('+paymentID+')']);},showServerErrors:function(responseData,uuid){if(responseData['@issues']){var L=responseData['@issues'].length;myControl.util.dump("responseData['_rtag'].targetID: "+responseData['_rtag'].targetID);var $errorDiv=responseData['_rtag'].targetID?$('#'+responseData['_rtag'].targetID):$('#chkoutSummaryErrors')
$errorDiv.empty();if($errorDiv.length==0)
$errorDiv=$("<p \/>").attr("id","chkoutSummaryErrors").addClass("zwarn displayNone").prependTo($('#zCheckoutFrm'));var o="<ul>";for(var i=0;i<L;i+=1){o+="<li>"+responseData['@issues'][i][3]+"<\/li>";}
o+="<\/ul>";$errorDiv.append(myControl.util.formatMessage({"message":o,"uiClass":"error","uiIcon":"alert"})).toggle(true);}
else{myControl.util.handleErrors(responseData,uuid)}},handlePanel:function(panel,hidden){var cssClass=hidden==true?'displayNone':'';var o="<legend id='"+panel+"Legend' class='ui-widget-header ui-corner-all'>"+myControl.ext.convertSessionToOrder.vars.legends[panel]+"<\/legend>";o+="<div id='"+panel+"FieldsetErrors'><\/div>";if(!$('#'+panel+'Fieldset').length>0){$('#zCheckoutFrm').append("<fieldset id='"+panel+"Fieldset' class='ui-widget ui-widget-content ui-corner-all loadingBG "+cssClass+"'>"+o+"<\/fieldset>");}
else{$('#'+panel+'Fieldset').empty().addClass(' ui-widget ui-widget-content ui-corner-all loadingBG '+cssClass).append(o);}
},updateShipMethod:function(shipID,safeID){myControl.calls.cartSet.init({'ship.selected_id':shipID});myControl.ext.convertSessionToOrder.calls.getCartContents.init('updateCheckoutOrderContents');myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutPayOptions');myControl.ext.convertSessionToOrder.calls.appPaymentMethods.init("updateCheckoutPayOptions");if(safeID){$("#chkout-shipMethods li").removeClass("selected ui-state-active ui-corner-all");$('.shipcon_'+safeID).addClass('selected ui-state-active ui-corner-all');}
_gaq.push(['_trackEvent','Checkout','User Event','Shipping method selected ('+shipID+')']);},selectPredefinedAddress:function(addressObject){var $x=$(addressObject);var addressClass=$x.attr('data-addressClass');$("#"+addressClass+"AddressUL").toggle(false);myControl.ext.convertSessionToOrder.utilities.removeClassFromChildAddresses($x.parent().attr('id'));$x.addClass('selected  ui-state-active ui-corner-all');var idObj={};idObj["data.selected_"+addressClass+"_id"]=$x.attr('data-addressId');myControl.calls.cartSet.init(idObj);myControl.sharedCheckoutUtilities.setAddressFormFromPredefined(addressClass,$x.attr('data-addressId'));if($('#chkout-bill_to_ship').val()=='1'){myControl.sharedCheckoutUtilities.setShipAddressToBillAddress();}
myControl.ext.convertSessionToOrder.calls.saveCheckoutFields.init();if(addressClass=='bill'){myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutPayOptions');myControl.ext.convertSessionToOrder.calls.appPaymentMethods.init("updateCheckoutPayOptions");}
else if(addressClass=='ship'){myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutShipMethods');myControl.ext.convertSessionToOrder.calls.cartShippingMethodsWithUpdate.init("updateCheckoutShipMethods");}
else{myControl.util.dump(" -> UNKNOWN class for address selection. should be bill or ship. is: "+addressClass);}
myControl.ext.convertSessionToOrder.calls.getCartContents.init('updateCheckoutOrderContents');myControl.model.dispatchThis('immutable');_gaq.push(['_trackEvent','Checkout','User Event','Pre-defined address selected ('+addressClass+')']);},toggleShipAddressPanel:function(){myControl.util.dump('BEGIN myControl.ext.convertSessionToOrder.utilities.toggleShipAddressPanel');if($('#chkout-bill_to_ship_cb').is(':checked')){myControl.util.dump(' -> bill to ship IS checked (hide shipping address panel)');$('#chkoutShipAddressFieldset').toggle(false);$('#chkout-bill_to_ship').val('1');myControl.sharedCheckoutUtilities.setShipAddressToBillAddress();myControl.ext.convertSessionToOrder.calls.saveCheckoutFields.init();myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutShipMethods');myControl.ext.convertSessionToOrder.calls.cartShippingMethodsWithUpdate.init("updateCheckoutShipMethods");myControl.ext.convertSessionToOrder.calls.getCartContents.init('updateCheckoutOrderContents');}
else{myControl.util.dump('bill to ship is NOT checked (show shipping address panel)');myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutShipAddress');$('#chkoutShipAddressFieldset').toggle(true);myControl.ext.convertSessionToOrder.panelContent.shipAddress();$('#chkout-bill_to_ship').val("0");myControl.calls.cartSet.init({"chkout.bill_to_ship":"0"});};myControl.model.dispatchThis('immutable');},addressFieldUpdated:function(fieldID){myControl.util.dump("BEGIN myControl.ext.convertSessionToOrder.utilities.addressFieldUpdated");var SUCR=false;this.handleBill2Ship();if(myControl.ext.convertSessionToOrder.utilities.taxShouldGetRecalculated()){myControl.util.dump(" -> saveCheckoutFields originated from addressFieldUpdated");myControl.ext.convertSessionToOrder.calls.saveCheckoutFields.init();myControl.ext.convertSessionToOrder.calls.getCartContents.init('updateCheckoutOrderContents');SUCR=true;}
if(fieldID.indexOf('zip')>0||fieldID.indexOf('country')>0){var TYPE=fieldID.indexOf('ship')>0?'ship':'bill';myControl.util.dump(" -> type: "+TYPE);this.recalculateShipMethods(TYPE,SUCR);}},handleBill2Ship:function(){var billToShip=($('#chkout-bill_to_ship').val())*1;if(billToShip){myControl.util.dump(" -> billToShip is true. update ship inputs with current zip/country.");myControl.sharedCheckoutUtilities.setShipAddressToBillAddress();}
myControl.util.dump(" -> handleBill2Ship val: "+billToShip);return billToShip;},taxShouldGetRecalculated:function(){myControl.util.dump("BEGIN myControl.ext.convertSessionToOrder.utilities.taxShouldGetRecalculated");var r=true;var errors=0;if(!$('#data-bill_address1').val()){myControl.util.dump(" -> address is blank");errors+=1;}
if(!$('#data-bill_city').val()){myControl.util.dump(" -> city is blank");errors+=1;}
if(!$('#data-bill_state').val()){myControl.util.dump(" -> state is blank");errors+=1;}
if(!$('#data-bill_zip').val()){myControl.util.dump(" -> zip is blank");errors+=1;}
if(!$('#data-bill_country').val()){myControl.util.dump(" -> country is blank");errors+=1;}
if(errors>0){r=false;}
if(r){_gaq.push(['_trackEvent','Checkout','App Event','Gathered enough input to display tax']);}
myControl.util.dump(" -> tax should be recalculated = "+r);myControl.util.dump("END myControl.ext.convertSessionToOrder.utilities.taxShouldGetRecalculated");return r;},recalculateShipMethods:function(TYPE,SUCR){var billToShip=this.handleBill2Ship();if(TYPE=='bill'&&billToShip==0){myControl.util.dump(" -> bill zip/country changed, but ship to billing is NOT checked, so no update needed.");}
else{myControl.util.dump(" -> zip/country changed (type = "+TYPE+"). ship to bill = "+billToShip+" and typeof billToShop (should be number) = "+typeof billToShip);if(!SUCR){myControl.util.dump(" -> saveCheckoutFields originated from recalculateShipMethods");myControl.ext.convertSessionToOrder.calls.saveCheckoutFields.init();myControl.ext.convertSessionToOrder.calls.getCartContents.init('updateCheckoutOrderContents');}
if(billToShip){myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutPayOptions');myControl.ext.convertSessionToOrder.calls.appPaymentMethods.init("updateCheckoutPayOptions");}
myControl.ext.convertSessionToOrder.utilities.handlePanel('chkoutShipMethods');myControl.ext.convertSessionToOrder.calls.cartShippingMethodsWithUpdate.init("updateCheckoutShipMethods");}},removeClassFromChildAddresses:function(parentDivId){$('#'+parentDivId+' address').each(function(){$(this).removeClass('selected  ui-state-active');});}},renderFormats:{countriesAsOptions:function($tag,data){var r='';var L=myControl.data.appCheckoutDestinations['@destinations'].length;for(var i=0;i<L;i+=1){r+="<option value='"+myControl.data.appCheckoutDestinations['@destinations'][i].ISO+"' ";if(data.bindData.cleanValue==myControl.data.appCheckoutDestinations['@destinations'][i].Z)
r+=" selected='selected' ";r+=">"+myControl.data.appCheckoutDestinations['@destinations'][i].Z+"</option>";}
$tag.html(r);},secureLink:function($tag,data){if(myControl.util.isSet(data.windowName))
$tag.click(function(){window.open(myControl.vars.secureURL+$.trim(data.value)),data.windowName});else
$tag.click(function(){window.location=myControl.vars.secureURL+$.trim(data.value)});},orderStatusLink:function($tag,data){var orderSessionID=myControl.data['order|'+data.value].cart.id;$tag.click(function(){window.location=myControl.vars.secureURL+"customer/order/status?cartid="+orderSessionID+"&amp;orderid="+data.value,'orderStatus'});},shipInfoById:function($tag,data){var o='';var L=myControl.data.cartShippingMethods['@methods'].length;for(var i=0;i<L;i+=1){if(myControl.data.cartShippingMethods['@methods'][i].id==data.value){var pretty=myControl.util.isSet(myControl.data.cartShippingMethods['@methods'][i]['pretty'])?myControl.data.cartShippingMethods['@methods'][i]['pretty']:myControl.data.cartShippingMethods['@methods'][i]['name'];o="<span class='orderShipMethod'>"+pretty+": <\/span>";if(myControl.data.cartShippingMethods['@methods'][i].amount){o+="<span class='orderShipAmount'>"+myControl.util.formatMoney(myControl.data.cartShippingMethods['@methods'][i].amount,' $',2,false)+"<\/span>";}
break;}}
$tag.html(o);},shipMethodsAsOptions:function($tag,data){var o='';var L=data.value.length;var id,isSelectedMethod,safeid,shipName;for(var i=0;i<L;i+=1){isSelectedMethod=false;safeid=myControl.util.makeSafeHTMLId(data.value[i].id);id=data.value[i].id;if(id==myControl.data.cartItemsList.cart['ship.selected_id']){isSelectedMethod=true;}
shipName=myControl.util.isSet(data.value[i].pretty)?data.value[i].pretty:data.value[i].name
o+="<option "
if(isSelectedMethod)
o+=" selected='selected' ";o+=" value = '"+id+"' id='ship-selected_id_"+safeid+"' >"+shipName+" - "+myControl.util.formatMoney(data.value[i].amount,'$','',false)+"<\/option>";}
$tag.html(o);},shipMethodsAsRadioButtons:function($tag,data){var o='';var shipName;var L=data.value.length;var id,isSelectedMethod,safeid;for(var i=0;i<L;i+=1){isSelectedMethod=false;safeid=myControl.util.makeSafeHTMLId(data.value[i].id);id=data.value[i].id;if(id==myControl.data.cartItemsList.cart['ship.selected_id']){isSelectedMethod=true;}
shipName=myControl.util.isSet(data.value[i].pretty)?data.value[i].pretty:data.value[i].name
o+="<li class='shipcon "
if(isSelectedMethod)
o+=' ui-state-active selected ui-corner-all ';o+="shipcon_"+safeid;o+="'><input type='radio' name='ship.selected_id' id='ship-selected_id_"+safeid+"' value='"+id+"' onClick='myControl.ext.convertSessionToOrder.utilities.updateShipMethod(this.value,\""+safeid+"\"); myControl.model.dispatchThis(\"immutable\"); '";if(isSelectedMethod)
o+=" checked='checked' "
o+="/><label for='ship-selected_id_"+safeid+"'>"+shipName+": <span >"+myControl.util.formatMoney(data.value[i].amount,'$','',false)+"<\/span><\/label><\/li>";}
$tag.html(o);},payMethodsAsRadioButtons:function($tag,data){var L=data.value.length;var o="";var id='';var i,isSelectedMethod;for(i=0;i<L;i+=1){isSelectedMethod=false;id=data.value[i].id;if(id=='PAYPALEC'){}
else{if(id==myControl.data.cartItemsList.cart['chkout.payby']){isSelectedMethod=true;}
o+="<li class='paycon_"+id+"' id='payby_"+id+"'><div class='paycon'><input type='radio' name='chkout.payby' id='chkout-payby_"+id+"' value='"+id+"' onClick='myControl.ext.convertSessionToOrder.utilities.updatePayDetails(this.value); myControl.calls.cartSet.init({\"chkout.payby\":this.value}); myControl.model.dispatchThis(\"immutable\"); $(\"#chkoutPayOptionsFieldsetErrors\").addClass(\"displayNone\");' ";if(isSelectedMethod)
o+=" checked='checked' "
o+="/><label for='chkout-payby_"+id+"'>"+data.value[i].pretty+"<\/label></div><\/li>";}}
$tag.html(o);},orderBalance:function($tag,data){var o='';var amount=data.bindData.cleanValue;o+=data.bindData.pretext?data.bindData.pretext:'';if(amount*1<=0){o+=data.bindData.currencySign?data.bindData.currencySign:'$';o+='0.00';}
else{o+=myControl.util.formatMoney(amount,data.bindData.currencySign,'',data.bindData.hideZero);}
o+=data.bindData.posttext?data.bindData.posttext:'';$tag.text(o);},accessoryUpsell:function($tag,data){}}}
return r;}